<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Sentinel</title>
  <style>
    /* THEME VARIABLES */
    :root {
      --bg: #ffffff; --fg: #0f1115; --muted: #58627a;
      --hr: #111; --card: #ffffff; --card-border: #ddd;
      --btn-bg: #f2f4f8; --btn-fg: #0f1115; --btn-border: #c9ceda;
      --input-bg: #fff; --input-fg: #0f1115; --input-border: #c9ceda;
      --accent: #2f80ed; --good: #1b9e3e; --warn: #e6a700; --bad: #d64545;
    }
    :root[data-theme="dark"] {
      --bg: #0f1115; --fg: #e3e6ee; --muted: #a4acc2;
      --hr: #222834; --card: #121826; --card-border: #2a3140;
      --btn-bg: #1a2030; --btn-fg: #e3e6ee; --btn-border: #323a4d;
      --input-bg: #0f141f; --input-fg: #e3e6ee; --input-border: #323a4d;
      --accent: #6aa2ff; --good: #37d27a; --warn: #ffd45e; --bad: #ff7a7a;
    }

    /* BASE */
    html, body { height: 100%; }
    body { margin: 14px; font-family: Segoe UI, Arial, sans-serif; background: var(--bg); color: var(--fg); transition: background .2s, color .2s; }
    h1 { margin: 0 0 18px; display:flex; align-items:center; gap:10px; }
    .hr { height: 10px; background: var(--hr); margin: 16px 0 12px; border-radius: 2px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button { padding:6px 10px; background:var(--btn-bg); color:var(--btn-fg); border:1px solid var(--btn-border); border-radius:8px; cursor:pointer; }
    input, select { padding:6px 8px; background:var(--input-bg); color:var(--input-fg); border:1px solid var(--input-border); border-radius:8px; }
    .card { background:var(--card); border:1px solid var(--card-border); border-radius:10px; padding:12px; }
    .muted { color: var(--muted); }
    .mono { font-family: Consolas, monospace; }
    .danger { background:#ffe9e9; }
    .divider-v { width:1px; height:28px; background:var(--card-border); margin:0 6px; }

    /* polish */
    button:hover { transform: translateY(-1px); }
    .card:hover { box-shadow: 0 6px 18px rgba(0,0,0,.08); }

    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background: var(--btn-bg); border:1px solid var(--btn-border); color: var(--btn-fg); font-size: 12px; }

    .kpi-grid { display:grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap:12px; }
    .kpi { padding:8px 10px; border:1px solid var(--card-border); border-radius:10px; }
    .kpi .label { font-size:12px; color:var(--muted); }
    .kpi .value { font-family: Consolas, monospace; font-size:16px; }

    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab-btn.active { border-color: var(--accent); box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 20%, transparent); }
    .hidden { display:none; }

    /* Toast */
    #toast { position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:8px; z-index:9999; }
    .toast { background:var(--card); border:1px solid var(--card-border); padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.2); }

    /* Strength bar */
    .strength { height:8px; width:220px; background: #d0d5e1; border-radius:999px; overflow:hidden; }
    .strength > div { height:100%; width:0%; transition:width .2s; }
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between;">
    <h1>
      <img src="./build/icon.png" alt="Sentinel Logo" width="32" height="32" style="border-radius:6px;">
      <span class="app-title">Sentinel</span>
    </h1>
    <div class="row">
      <button id="btn-theme" title="Toggle light/dark">🌓 Theme</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-generator">🔑 Generator</button>
    <button class="tab-btn" data-tab="tab-vault">🗃️ Vault</button>
    <button class="tab-btn" data-tab="tab-settings">⚙️ Settings</button>
  </div>

  <!-- GENERATOR TAB -->
  <div id="tab-generator">
    <h3>1) Password Generator</h3>
    <div class="row">
      <label>Length: <input id="gen-length" type="number" value="20" min="6" max="128" style="width:70px;"></label>
      <label><input id="gen-symbols" type="checkbox" checked> Require symbols</label>
      <button id="btn-generate">Generate</button>
    </div>
    <div class="row" style="margin-top:10px;">
      <div id="gen-output" class="mono"></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="strength"><div id="gen-strength-bar"></div></div>
      <span id="gen-strength-label" class="muted"></span>
    </div>
    <div class="hr"></div>
  </div>

  <!-- VAULT TAB -->
  <div id="tab-vault" class="">
    <h3>2) Local Vault</h3>

    <!-- security row -->
    <div class="row" style="margin:10px 0;">
      <span id="vault-state" class="muted">Vault: checking…</span>
      <div class="divider-v"></div>

      <input id="master-input" type="password" placeholder="Master password" style="width: 220px;">
      <button id="btn-set-master">Create Master</button>
      <button id="btn-unlock">Unlock</button>
      <button id="btn-lock">Lock</button>

      <div class="divider-v"></div>

      <input id="old-master" type="password" placeholder="Old master" style="width:170px;">
      <input id="new-master" type="password" placeholder="New master" style="width:170px;">
      <button id="btn-change-master">Change Master</button>
    </div>

    <!-- add row -->
    <div class="row" style="margin-top:8px;">
      <input id="site" type="text" placeholder="Site (e.g., example.com)" style="width:260px;">
      <input id="username" type="text" placeholder="Username / Email" style="width:260px;">
      <input id="password" type="text" placeholder="Password" style="width:260px;">
      <button id="btn-add">Add Account</button>
    </div>

    <!-- list controls -->
    <div class="row" style="margin-top:8px;">
      <button id="btn-refresh">Refresh List</button>
      <button id="btn-show-path">Show vault path</button>
      <div class="divider-v"></div>
      <input id="search-input" type="text" placeholder="Search site or username" style="width:240px;">
      <select id="sort-select">
        <option value="updated-desc">Sort: Updated ↓</option>
        <option value="updated-asc">Sort: Updated ↑</option>
        <option value="site-asc">Sort: Site A→Z</option>
        <option value="site-desc">Sort: Site Z→A</option>
      </select>
      <label><input id="hide-passwords" type="checkbox" checked> Hide passwords</label>
    </div>

    <!-- audit panel -->
    <div id="vault-audit" class="card" style="margin-top:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong>Vault Audit</strong>
        <span class="badge" id="audit-scope">All items</span>
      </div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="label">Total</div>
          <div class="value" id="kpi-total">0</div>
        </div>
        <div class="kpi">
          <div class="label">Reused passwords</div>
          <div class="value" id="kpi-reused">0</div>
        </div>
        <div class="kpi">
          <div class="label">Weak (&lt; 40)</div>
          <div class="value" id="kpi-weak">0</div>
        </div>
        <div class="kpi">
          <div class="label">Strong (≥ 66)</div>
          <div class="value" id="kpi-strong">0</div>
        </div>
      </div>
    </div>

    <!-- list -->
    <div id="vault-list" class="card" style="max-height:260px; overflow:auto; margin-top:10px;">
      <span class="muted">No accounts yet.</span>
    </div>

    <div class="hr"></div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="tab-settings" class="hidden">
    <h3>3) Settings</h3>
    <div class="row">
      <button id="btn-export">💾 Export Vault</button>
      <button id="btn-import">📥 Import Vault</button>
    </div>

    <div class="card" style="margin-top:12px; max-width:520px;">
      <strong>Security & Clipboard</strong>
      <div class="row" style="margin-top:10px;">
        <label>Auto-lock after 
          <input id="set-autolock-min" type="number" min="1" max="180" value="5" style="width:70px;"> minutes
        </label>
        <label class="row" style="margin-left:10px;">Clipboard clear 
          <input id="set-clipboard-sec" type="number" min="1" max="300" value="20" style="width:70px; margin-left:6px;"> s
        </label>
        <button id="btn-save-settings">Save</button>
      </div>
      <div class="muted" style="margin-top:6px;">
        Changes apply immediately and persist across restarts.
      </div>
    </div>

    <div class="hr"></div>
  </div>

  <!-- Toast container -->
  <div id="toast"></div>

  <script>
    /* ---------- THEME ---------- */
    const THEME_KEY = 'app:theme';
    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === 'dark') root.setAttribute('data-theme','dark');
      else root.removeAttribute('data-theme');
      localStorage.setItem(THEME_KEY, theme);
    }
    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') applyTheme(saved);
      else applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e)=>applyTheme(e.matches?'dark':'light'));
    }
    document.getElementById('btn-theme').onclick = () => {
      const cur = localStorage.getItem(THEME_KEY) || 'light';
      applyTheme(cur === 'light' ? 'dark' : 'light');
      showToast(`Theme: ${localStorage.getItem(THEME_KEY)}`);
    };
    initTheme();

    /* ---------- TOASTS ---------- */
    function showToast(msg, ms=1600) {
      const wrap = document.getElementById('toast');
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; }, ms);
      setTimeout(()=>wrap.removeChild(t), ms+350);
    }

    /* ---------- CLIPBOARD (configurable) ---------- */
    let CLIPBOARD_CLEAR_MS = 20000; // overwritten by settings

    async function writeClipboardWithClear(text, ms = CLIPBOARD_CLEAR_MS) {
      if (!navigator.clipboard) return;
      await navigator.clipboard.writeText(text);
      showToast(`Copied to clipboard — clears in ${Math.round(ms/1000)}s`);
      setTimeout(async () => { try { await navigator.clipboard.writeText(' '); } catch {} }, ms);
    }

    /* ---------- TABS ---------- */
    const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
    const tabs = {
      'tab-generator': document.getElementById('tab-generator'),
      'tab-vault': document.getElementById('tab-vault'),
      'tab-settings': document.getElementById('tab-settings'),
    };
    tabButtons.forEach(btn=>{
      btn.onclick = ()=>{
        tabButtons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tabs).forEach(el=>el.classList.add('hidden'));
        tabs[btn.dataset.tab].classList.remove('hidden');
      };
    });

    /* ---------- GENERATOR ---------- */
    function randomPassword(len, symbols) {
      const letters = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const sym = '!@#$%^&*()-_=+[]{};:,<.>/?';
      const set = letters + (symbols ? sym : '');
      const arr = new Uint32Array(len);
      window.crypto.getRandomValues(arr);
      let out=''; 
      for (let i=0;i<len;i++) out += set[arr[i] % set.length];
      return out;
    }
    function strengthScore(pw){
      if(!pw) return 0;
      let s = 0;
      if (pw.length >= 8) s+=20;
      if (pw.length >= 12) s+=20;
      if (/[a-z]/.test(pw)) s+=15;
      if (/[A-Z]/.test(pw)) s+=15;
      if (/\d/.test(pw)) s+=15;
      if (/[^A-Za-z0-9]/.test(pw)) s+=15;
      return Math.min(s,100);
    }
    function renderStrength(pw, barEl, labelEl){
      const s = strengthScore(pw);
      barEl.style.width = s+'%';
      let color = 'linear-gradient(90deg, var(--bad), var(--warn))';
      let label = 'Weak';
      if (s >= 66) { color = 'linear-gradient(90deg, var(--warn), var(--good))'; label='Strong'; }
      else if (s >= 40) { color = 'linear-gradient(90deg, var(--bad), var(--warn))'; label='Okay'; }
      barEl.style.background = color;
      labelEl.textContent = label + ` (${s})`;
    }
    const genBar = document.getElementById('gen-strength-bar');
    const genLabel = document.getElementById('gen-strength-label');

    document.getElementById('btn-generate').onclick = () => {
      const len = parseInt(document.getElementById('gen-length').value, 10) || 16;
      const useSym = document.getElementById('gen-symbols').checked;
      const pw = randomPassword(len, useSym);
      document.getElementById('gen-output').textContent = pw;
      renderStrength(pw, genBar, genLabel);
      writeClipboardWithClear(pw);
    };

    /* ---------- VAULT ---------- */
    const listEl = document.getElementById('vault-list');
    const siteEl = document.getElementById('site');
    const userEl = document.getElementById('username');
    const passEl = document.getElementById('password');
    const searchEl = document.getElementById('search-input');
    const hidePwEl = document.getElementById('hide-passwords');
    const sortSel = document.getElementById('sort-select');

    let cachedAccounts = [];

    async function refreshVaultState() {
      const enc = await window.vault.isEncrypted();
      document.getElementById('vault-state').textContent = enc ? 'Vault: Encrypted (locked or unlocked)' : 'Vault: Unencrypted';
    }

    function mask(t){ return '•'.repeat(Math.max(8, String(t||'').length)); }

    function renderList(accounts) {
      listEl.innerHTML = '';
      if (!accounts.length) { listEl.innerHTML = '<span class="muted">No accounts yet.</span>'; return; }
      const hidePw = hidePwEl.checked;
      accounts.forEach(a=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '8px';
        card.innerHTML = `
          <div class="mono"><strong>${a.site}</strong></div>
          <div class="mono">user: ${a.username}</div>
          <div class="mono">
            pass:
            <span data-pw="${a.password}">${hidePw ? mask(a.password) : a.password}</span>
            <button data-act="reveal" data-id="${a.id}" style="margin-left:6px;">
              ${hidePw ? 'Show' : 'Hide'}
            </button>
          </div>
          <div class="muted mono">updated: ${a.updatedAt}</div>
          <div style="margin-top:6px;">
            <button data-act="copy" data-id="${a.id}">Copy Password</button>
            <button data-act="random" data-id="${a.id}">Set New Random Password</button>
            <button class="danger" data-act="remove" data-id="${a.id}">Remove</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function sortAccounts(list){
      const v = sortSel.value;
      const copy = list.slice();
      if (v === 'updated-desc') copy.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
      if (v === 'updated-asc') copy.sort((a,b)=>new Date(a.updatedAt)-new Date(b.updatedAt));
      if (v === 'site-asc') copy.sort((a,b)=>String(a.site).localeCompare(String(b.site)));
      if (v === 'site-desc') copy.sort((a,b)=>String(b.site).localeCompare(String(a.site)));
      return copy;
    }

    function updateAudit(filteredList) {
      const scopeEl = document.getElementById('audit-scope');
      const totalEl = document.getElementById('kpi-total');
      const reusedEl = document.getElementById('kpi-reused');
      const weakEl = document.getElementById('kpi-weak');
      const strongEl = document.getElementById('kpi-strong');
      if (!scopeEl) return;

      if (filteredList === null) {
        scopeEl.textContent = 'Locked';
        totalEl.textContent = '—';
        reusedEl.textContent = '—';
        weakEl.textContent = '—';
        strongEl.textContent = '—';
        return;
      }

      const all = cachedAccounts || [];
      const list = Array.isArray(filteredList) ? filteredList : all;
      scopeEl.textContent = (list.length === all.length) ? 'All items' : `Filtered (${list.length}/${all.length})`;

      totalEl.textContent = String(list.length);

      const counts = Object.create(null);
      for (const a of list) {
        const pw = a.password || '';
        counts[pw] = (counts[pw] || 0) + 1;
      }
      let reused = 0;
      for (const pw in counts) if (counts[pw] > 1) reused += counts[pw];
      reusedEl.textContent = String(reused);

      let weak = 0, strong = 0;
      for (const a of list) {
        const s = strengthScore(a.password || '');
        if (s < 40) weak++;
        if (s >= 66) strong++;
      }
      weakEl.textContent = String(weak);
      strongEl.textContent = String(strong);
    }

    function applyFilter() {
      const q = searchEl.value.trim().toLowerCase();
      const filtered = !q ? cachedAccounts
        : cachedAccounts.filter(a =>
            (a.site||'').toLowerCase().includes(q) ||
            (a.username||'').toLowerCase().includes(q)
          );
      renderList(sortAccounts(filtered));
      updateAudit(filtered);
    }

    async function refreshList() {
      try {
        cachedAccounts = await window.vault.list();
        applyFilter();
      } catch {
        listEl.innerHTML = '<div class="muted">🔒 Vault is locked. Unlock to view entries.</div>';
        updateAudit(null);
      }
    }

    // events
    document.getElementById('btn-add').onclick = async () => {
      const site = siteEl.value.trim(), username = userEl.value.trim(), password = passEl.value.trim();
      if (!site || !username || !password) return showToast('Fill all fields', 1400);
      try {
        await window.vault.add({ site, username, password });
        siteEl.value = userEl.value = passEl.value = '';
        await refreshList();
        showToast('Account added');
      } catch (e) { showToast(e.message || 'Failed to add'); }
    };
    document.getElementById('btn-refresh').onclick = refreshList;
    document.getElementById('btn-show-path').onclick = async () => {
      const p = await window.vault.paths();
      const txt = `Plaintext: ${p.PLAINTEXT_FILE}\nEncrypted: ${p.ENCRYPTED_FILE}`;
      await navigator.clipboard?.writeText(txt);
      showToast('Paths copied');
    };

    listEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = Number(btn.dataset.id); const act = btn.dataset.act;

      if (act === 'copy') {
        const accounts = await window.vault.list();
        const found = accounts.find(a=>a.id===id);
        if (found) { await writeClipboardWithClear(found.password); }
      }

      if (act === 'random') {
        const newPw = randomPassword(20,true);
        try { await window.vault.updatePass(id,newPw); await refreshList(); showToast('Password updated'); }
        catch (err) { showToast(err.message || 'Update failed'); }
      }

      if (act === 'reveal') {
        const span = btn.closest('.card').querySelector('span[data-pw]');
        const real = span.getAttribute('data-pw');
        const masked = span.textContent.startsWith('•');
        if (masked) { span.textContent = real; btn.textContent = 'Hide'; }
        else { span.textContent = mask(real); btn.textContent = 'Show'; }
      }

      if (act === 'remove') {
        if (confirm('Remove this account?')) { await window.vault.remove(id); await refreshList(); showToast('Removed'); }
      }
    });

    searchEl.addEventListener('input', applyFilter);
    hidePwEl.addEventListener('change', applyFilter);
    sortSel.addEventListener('change', applyFilter);

    // security buttons
    document.getElementById('btn-set-master').onclick = async () => {
      const pw = document.getElementById('master-input').value;
      if (!pw) return showToast('Enter a master password');
      try { await window.vault.setMaster(pw); await refreshVaultState(); await refreshList(); showToast('Vault encrypted'); }
      catch (e) { showToast(e.message || 'Failed'); }
    };
    document.getElementById('btn-unlock').onclick = async () => {
      const pw = document.getElementById('master-input').value;
      if (!pw) return showToast('Enter your master password');
      try { await window.vault.unlock(pw); await refreshList(); showToast('Unlocked'); armAutolock(); }
      catch (e) { showToast('Unlock failed'); }
    };
    document.getElementById('btn-lock').onclick = async () => { await window.vault.lock(); await refreshList(); showToast('Locked'); };
    document.getElementById('btn-change-master').onclick = async () => {
      const oldPw = document.getElementById('old-master').value;
      const newPw = document.getElementById('new-master').value;
      if (!oldPw || !newPw) return showToast('Enter old + new master');
      if (newPw.length < 8) return showToast('New master too short');
      try { await window.vault.changeMaster(oldPw,newPw); showToast('Master changed'); await refreshVaultState(); await refreshList(); }
      catch (e) { showToast('Change failed'); }
    };

    // SETTINGS: Export / Import
    document.getElementById('btn-export').onclick = async ()=>{
      try { const ok = await window.files.exportVault(); if (ok) showToast('Exported'); }
      catch(e){ showToast('Export failed'); }
    };
    document.getElementById('btn-import').onclick = async ()=>{
      try { const ok = await window.files.importVault(); if (ok) { await refreshList(); showToast('Imported'); } }
      catch(e){ showToast('Import failed'); }
    };

    // SETTINGS: Save
    document.getElementById('btn-save-settings').onclick = async () => {
      const minVal = Number(document.getElementById('set-autolock-min').value);
      const secVal = Number(document.getElementById('set-clipboard-sec').value);

      const minutes = Math.max(1, Math.min(180, isNaN(minVal) ? 5 : minVal));
      const seconds = Math.max(1, Math.min(300, isNaN(secVal) ? 20 : secVal));

      await window.appSettings.set('autolockMinutes', minutes);
      await window.appSettings.set('clipboardSeconds', seconds);

      AUTOLOCK_MS = minutes * 60 * 1000;
      CLIPBOARD_CLEAR_MS = seconds * 1000;
      armAutolock();

      showToast('Settings saved');
    };

    /* ---------- AUTO-LOCK ---------- */
    let AUTOLOCK_MS = 5 * 60 * 1000; // overwritten by settings
    let _lockTimer = null;

    function armAutolock() {
      clearTimeout(_lockTimer);
      _lockTimer = setTimeout(async () => {
        try {
          await window.vault.lock();
          await refreshList();
          showToast('Auto-locked');
          updateAudit(null);
        } catch {}
      }, AUTOLOCK_MS);
    }

    ['mousemove','keydown','click','wheel','touchstart','visibilitychange'].forEach(evt => {
      window.addEventListener(evt, () => {
        if (document.hidden) return;
        armAutolock();
      }, { passive: true });
    });

    /* ---------- LOAD SETTINGS + INIT ---------- */
    async function loadAndApplySettings() {
      try {
        const all = await window.appSettings.all();
        const minutes = Number(all.autolockMinutes) || 5;
        const seconds = Number(all.clipboardSeconds) || 20;
        AUTOLOCK_MS = minutes * 60 * 1000;
        CLIPBOARD_CLEAR_MS = seconds * 1000;
        const autolockInput = document.getElementById('set-autolock-min');
        const clipInput = document.getElementById('set-clipboard-sec');
        if (autolockInput) autolockInput.value = String(minutes);
        if (clipInput) clipInput.value = String(seconds);
      } catch {}
    }

    (async () => {
      await loadAndApplySettings();
      armAutolock();
      refreshVaultState();
      refreshList();
    })();
  </script>
</body>
</html>
